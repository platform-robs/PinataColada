<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrativo | Pi√±ata Colada</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>

/* ===============================
   BASE
================================ */

body{
margin:0;
font-family:'Montserrat',sans-serif;
background:#0f1116;
color:white;
}

.container{ padding:25px; }

/* ===============================
   NAVBAR
================================ */

.admin-nav{
display:flex;
justify-content:space-between;
align-items:center;
background:#1b1f2a;
padding:15px 20px;
border-radius:16px;
margin-bottom:20px;
}

.admin-links{
display:flex;
gap:10px;
flex-wrap:wrap;
}

.admin-links button{
background:rgba(255,255,255,.08);
color:white;
border:none;
padding:8px 14px;
border-radius:999px;
cursor:pointer;
font-weight:700;
}

.admin-links button.active{
background:#28a745;
}

.admin-menu-btn{
display:none;
background:rgba(255,255,255,.08);
color:white;
border:none;
padding:8px 12px;
border-radius:10px;
font-size:20px;
}

/* ===============================
   CARDS
================================ */

.card{
background:#1b1f2a;
padding:20px;
border-radius:16px;
margin-bottom:15px;
text-align:center;
}

.card button{
margin:5px;
}

/* ===============================
   BOTONES
================================ */

.btn-primary{ background:#28a745; color:white; }
.btn-edit{ background:#17a2b8; color:white; }
.btn-delete{ background:#dc3545; color:white; }
.btn-ticket{ background:#6f42c1; color:white; }

button{
border:none;
padding:8px 14px;
border-radius:999px;
cursor:pointer;
font-weight:700;
}

/* ===============================
   POPUP
================================ */

.popup-overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,.7);
display:flex;
justify-content:center;
align-items:center;
z-index:999;
}

.popup{
background:#f8f9fc;
color:#1b1f2a;
width:95%;
max-width:900px;
max-height:90vh;
overflow-y:auto;
border-radius:20px;
padding:30px;
box-shadow:0 30px 80px rgba(0,0,0,.4);
text-align:left;
}

.popup h2{
text-align:center;
margin-bottom:20px;
}

.popup label{
font-weight:700;
font-size:13px;
display:block;
margin-top:12px;
}

.popup input,
.popup select{
width:100%;
padding:10px;
margin:6px 0;
border-radius:10px;
border:1px solid #ccc;
text-align:center;
}

.close-btn{
background:#dc3545;
color:white;
margin-top:15px;
}

/* ===============================
   RESPONSIVE
================================ */

@media(max-width:768px){
.admin-links{ display:none; }
.admin-menu-btn{ display:block; }
}

@media print {
  body * {
    visibility: hidden;
  }

  .popup, .popup * {
    visibility: visible;
  }

  .popup {
    position: absolute;
    left: 0;
    top: 0;
    width: 100%;
    box-shadow: none;
  }

  .close-btn, .btn-primary {
    display: none;
  }
}
   
</style>
</head>

<body>

<div class="container">

<header class="admin-nav">
  <div style="font-weight:900;">Panel ‚Äî Pi√±ata Colada</div>

  <div class="admin-links" id="navbar"></div>

  <button class="admin-menu-btn" onclick="toggleMenu()">‚ò∞</button>
</header>

<div id="lista"></div>

</div>

<script>

const API="https://script.google.com/macros/s/AKfycbxbfuPfXY4BdGY0Xxu8o8uQKxrXl7o8I_QE7Oe6agng8RmEBkgWcQEW2nEBgRPvW0LA/exec";

let cotizaciones=[];
let tickets=[];
let filtroActual="Todos";


function formatDate(value){
  if(!value) return "";

  const d = new Date(value);
  if(isNaN(d)) return "";

  const year = d.getFullYear();
  const month = String(d.getMonth()+1).padStart(2,'0');
  const day = String(d.getDate()).padStart(2,'0');

  return `${year}-${month}-${day}`;
}


   
/* ===============================
   CARGAR
================================ */

async function cargar(){
const res=await fetch(API+"?action=getAll");
const data=await res.json();

cotizaciones=data.cotizaciones||[];
tickets=data.tickets||[];

render();
renderNavbar();
}

/* ===============================
   NAVBAR CON CONTADORES
================================ */

function renderNavbar(){

const estados=["Pendiente","En Desarrollo","Aprobada","Entregada","Cancelada"];

let html=`<button onclick="setFiltro('Todos')" class="${filtroActual==='Todos'?'active':''}">
Todos (${cotizaciones.length})
</button>`;

estados.forEach(e=>{
const count=cotizaciones.filter(c=>c.Estatus===e).length;

html+=`
<button onclick="setFiltro('${e}')" class="${filtroActual===e?'active':''}">
${e} (${count})
</button>`;
});

document.getElementById("navbar").innerHTML=html;
}

/* ===============================
   FILTRO
================================ */

function setFiltro(f){
filtroActual=f;
render();
renderNavbar();
}

/* ===============================
   RENDER
================================ */

function render(){

const lista=document.getElementById("lista");
lista.innerHTML="";

cotizaciones
.filter(c=>filtroActual==="Todos"||c.Estatus===filtroActual)
.forEach(c=>{

lista.innerHTML+=`
<div class="card">

<h3>${c.Folio} ‚Äî ${c.Cliente}</h3>
<p><strong>Evento:</strong> ${c.Evento}</p>
<p><strong>Precio:</strong> $${c.Precio||0}</p>
<p><strong>Anticipo:</strong> $${c.Anticipo||0}</p>
<p><strong>Estatus:</strong> ${c.Estatus}</p>

<button class="btn-edit" onclick="editar(${c.rowIndex})">Editar</button>
<button class="btn-ticket" onclick="crearTicket(${c.rowIndex})">Crear Ticket</button>
<button class="btn-delete" onclick="eliminar('${c.Folio}')">Eliminar</button>

${renderBotonesTickets(c.Folio)}

</div>
`;
});
}

/* ===============================
   EDITAR COMPLETO
================================ */

function editar(row){

const c = cotizaciones.find(x=>x.rowIndex===row);
if(!c) return;

let html = `
<h2>Editar Cotizaci√≥n</h2>
<p style="text-align:center;color:#666;margin-top:-10px;">
Modifica los campos necesarios y presiona "Guardar Todo"
</p>

<label>Folio (No editable)</label>
<input value="${c.Folio}" disabled>

<label>Fecha de solicitud</label>
<input id="Fecha_de_solicitud" value="${c["Fecha de solicitud"]||""}">

<label>Cliente</label>
<input id="Cliente" value="${c.Cliente||""}">

<label>Tama√±o</label>
<input id="Tama√±o" value="${c.Tama√±o||""}">

<label>Dise√±o</label>
<input id="Dise√±o" value="${c.Dise√±o||""}">

<label>Fecha de entrega</label>
<input 
  type="date" 
  id="Fecha_de_entrega"
  value="${formatDate(c["Fecha de entrega"])}">
<label>Evento</label>
<input id="Evento" value="${c.Evento||""}">

<label>Tel√©fono</label>
<input id="Tel√©fono" value="${c["Tel√©fono"]||""}">

<label>Detalles</label>
<input id="Detalles" value="${c.Detalles||""}">

<label>M√©todo de pago</label>
<input id="M√©todo_de_pago" value="${c["M√©todo de pago"]||""}">

<label>Entrega</label>
<input id="Entrega" value="${c.Entrega||""}">

<label>Ubicaci√≥n</label>
<input id="Ubicaci√≥n" value="${c.Ubicaci√≥n||""}">

<label>Estatus</label>
<select id="Estatus">
<option ${c.Estatus==="Pendiente"?"selected":""}>Pendiente</option>
<option ${c.Estatus==="En Desarrollo"?"selected":""}>En Desarrollo</option>
<option ${c.Estatus==="Aprobada"?"selected":""}>Aprobada</option>
<option ${c.Estatus==="Entregada"?"selected":""}>Entregada</option>
<option ${c.Estatus==="Cancelada"?"selected":""}>Cancelada</option>
</select>

<label>Precio</label>
<input id="Precio" type="number" value="${c.Precio||0}">

<button class="btn-primary" onclick="guardar(${row})">
Guardar Todo
</button>

<button class="close-btn" onclick="cerrar()">
Cerrar
</button>
`;

openPopup(html);
}

/* ===============================
   GUARDAR
================================ */

async function guardar(row){

const c = cotizaciones.find(x=>x.rowIndex===row);
if(!c) return;

const campos = {
action:"updateCotizacion",
rowIndex:row,
"Fecha de solicitud":document.getElementById("Fecha_de_solicitud").value,
Cliente:document.getElementById("Cliente").value,
Tama√±o:document.getElementById("Tama√±o").value,
Dise√±o:document.getElementById("Dise√±o").value,
"Fecha de entrega":document.getElementById("Fecha_de_entrega").value,
Evento:document.getElementById("Evento").value,
"Tel√©fono":document.getElementById("Tel√©fono").value,
Detalles:document.getElementById("Detalles").value,
"M√©todo de pago":document.getElementById("M√©todo_de_pago").value,
Entrega:document.getElementById("Entrega").value,
Ubicaci√≥n:document.getElementById("Ubicaci√≥n").value,
Estatus:document.getElementById("Estatus").value,
Precio:document.getElementById("Precio").value
};

await fetch(API,{
method:"POST",
body:JSON.stringify(campos)
});

cerrar();
cargar();
}

/* ===============================
   CREAR TICKET CON C√ÅLCULO
================================ */

function crearTicket(row){

const c = cotizaciones.find(x=>x.rowIndex===row);

const precio = parseFloat(c.Precio||0);
const anticipo = parseFloat(c.Anticipo||0);
const saldo = precio - anticipo;

let html = `
<h2>Crear Ticket</h2>

<p><strong>Folio:</strong> ${c.Folio}</p>
<p><strong>Cliente:</strong> ${c.Cliente}</p>
<p><strong>Evento:</strong> ${c.Evento}</p>

<p><strong>Precio:</strong> $${precio}</p>
<p><strong>Anticipo:</strong> $${anticipo}</p>
<p><strong>Saldo Pendiente:</strong> $${saldo}</p>

<button class="btn-primary" onclick="guardarTicket(${row})">
Guardar Ticket
</button>

<button class="close-btn" onclick="cerrar()">
Cerrar
</button>
`;

openPopup(html);
}

async function guardarTicket(row){

const c = cotizaciones.find(x=>x.rowIndex===row);

await fetch(API,{
method:"POST",
body:JSON.stringify({
action:"crearTicket",
Folio:c.Folio,
"Fecha de solicitud":c["Fecha de solicitud"],
Cliente:c.Cliente,
Tama√±o:c.Tama√±o,
Dise√±o:c.Dise√±o,
"Fecha de entrega":c["Fecha de entrega"],
Evento:c.Evento,
"Tel√©fono":c["Tel√©fono"],
"M√©todo de pago":c["M√©todo de pago"],
Entrega:c.Entrega,
Precio:c.Precio,
Anticipo:c.Anticipo
})
});

cerrar();
cargar();
}

/* ===============================
   ELIMINAR
================================ */

async function eliminar(folio){

if(!confirm("¬øEliminar?")) return;

await fetch(API,{
method:"POST",
body:JSON.stringify({
action:"deleteCotizacion",
folio:folio
})
});

cargar();
}

/* ===============================
   POPUP
================================ */

function openPopup(content){

document.body.insertAdjacentHTML("beforeend",`
<div class="popup-overlay" onclick="cerrar(event)">
<div class="popup" onclick="event.stopPropagation()">
${content}
</div>
</div>
`);
}

function cerrar(){
document.querySelector(".popup-overlay")?.remove();
}

function toggleMenu(){
document.getElementById("navbar").classList.toggle("show");
}

/* ===============================
   VER TICKETS
================================ */

function renderBotonesTickets(folio){

const relacionados = tickets.filter(t => t.Folio === folio);

if(relacionados.length === 0) return "";

let botones = "";

relacionados.forEach((t,i)=>{
  botones += `
    <button class="btn-primary" onclick="verTicket(${t.rowIndex})">
      Ver Ticket ${String.fromCharCode(65+i)}
    </button>
  `;
});

return botones;
}


function verTicket(row){

const t = tickets.find(x => x.rowIndex === row);
if(!t) return;

let html = `
<h2>üéüÔ∏è Ticket</h2>

<p><strong>Folio:</strong> ${t.Folio}</p>
<p><strong>Cliente:</strong> ${t.Cliente}</p>
<p><strong>Evento:</strong> ${t.Evento}</p>

<hr>

<p><strong>Precio:</strong> $${t.Precio}</p>
<p><strong>Anticipo:</strong> $${t.Anticipo}</p>
<p><strong>Saldo Pendiente:</strong> $${t["Saldo pendiente"]}</p>

<hr>

<p><strong>Fecha de solicitud:</strong> ${t["Fecha de solicitud"]}</p>
<p><strong>Fecha de entrega:</strong> ${t["Fecha de entrega"]}</p>
<p><strong>M√©todo de pago:</strong> ${t["M√©todo de pago"]}</p>
<p><strong>Entrega:</strong> ${t.Entrega}</p>

<button class="btn-primary" onclick="imprimirTicket()">
Imprimir
</button>

<button class="close-btn" onclick="cerrar()">
Cerrar
</button>
`;

openPopup(html);
}

function imprimirTicket(){
  window.print();
}
   
/* ===============================
   INICIAR
================================ */

cargar();

</script>

</body>
</html>
