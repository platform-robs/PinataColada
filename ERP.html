<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestor Piñata Colada</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --pink:#ff4fa6;
  --yellow:#ffd84d;
  --bg:#0f0f13;
  --card:#1b1b22;
  --text:#ffffff;
}

*{
  font-family:'Montserrat',sans-serif;
  text-align:center;
}

body{
  background:var(--bg);
  color:white;
  padding:20px;
}

.card{
  background:var(--card);
  padding:20px;
  border-radius:20px;
  margin-bottom:20px;
}

input, select{
  width:100%;
  padding:10px;
  margin:5px 0;
  border-radius:12px;
  border:none;
}

button{
  padding:10px 18px;
  border-radius:30px;
  border:none;
  margin-top:8px;
  font-weight:600;
  background:linear-gradient(135deg,var(--pink),var(--yellow));
  color:#000;
}
.delete{
  background:#ff3b3b;
  color:#fff;
}
</style>
</head>

<body>

<h2>Solicitudes de Cotización</h2>

<div id="list"></div>

<script>

const API_URL = "https://script.google.com/macros/s/AKfycbyhpSCLRXjePADfFhr7uM6gV8NU_nbplg2GtuGHUxCqGisULXfHUgf3pwsBc9eyfKPm/exec";
let cotizaciones = [];

async function cargar(){
  const res = await fetch(`${API_URL}?action=getCotizaciones`);
  cotizaciones = await res.json();
  render();
}

function render(){
  const list = document.getElementById("list");
  list.innerHTML="";

  cotizaciones.forEach(c => {

    const card = document.createElement("div");
    card.className="card";

    card.innerHTML = `
      <h3>${c.Folio}</h3>
      <p>${c.Cliente}</p>

      <select onchange="cambiarEstatus(${c.rowIndex},this.value)">
        <option ${c.Estatus=="Pendiente"?"selected":""}>Pendiente</option>
        <option ${c.Estatus=="En desarrollo"?"selected":""}>En desarrollo</option>
        <option ${c.Estatus=="Entregada"?"selected":""}>Entregada</option>
        <option ${c.Estatus=="Cancelada"?"selected":""}>Cancelada</option>
      </select>

      <input type="number" placeholder="Precio"
      value="${c.Precio || ""}"
      onchange="guardarDatos(${c.rowIndex})"
      id="precio${c.rowIndex}">

      <input type="number" placeholder="Anticipo"
      value="${c.Anticipo || ""}"
      onchange="guardarDatos(${c.rowIndex})"
      id="anticipo${c.rowIndex}">

      <p>Saldo: ${c.Saldo || 0}</p>

      <button onclick="crearTicket(${c.rowIndex})">
        Generar / Actualizar Ticket
      </button>

      <button class="delete" onclick="eliminar('${c.Folio}')">
        Eliminar
      </button>
    `;

    list.appendChild(card);
  });
}

async function guardarDatos(rowIndex){
  const precio = parseFloat(document.getElementById(`precio${rowIndex}`).value) || 0;
  const anticipo = parseFloat(document.getElementById(`anticipo${rowIndex}`).value) || 0;

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"updateCotizacion",
      rowIndex,
      estatus:"En desarrollo",
      precio,
      anticipo
    })
  });

  cargar();
}

async function cambiarEstatus(rowIndex,estatus){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"updateCotizacion",
      rowIndex,
      estatus,
      precio:0,
      anticipo:0
    })
  });

  cargar();
}

async function crearTicket(rowIndex){

  const c = cotizaciones.find(x => x.rowIndex == rowIndex);

  if(!c.Precio || c.Estatus=="Pendiente"){
    alert("Primero define precio y aprueba la cotización");
    return;
  }

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"saveTicket",
      folio:c.Folio,
      cliente:c.Cliente,
      telefono:c.Telefono,
      producto:c.Producto,
      fechaEntrega:c.FechaEntrega,
      precio:c.Precio,
      anticipo:c.Anticipo,
      estatus:c.Estatus
    })
  });

  alert("Ticket generado");
}

async function eliminar(folio){
  if(!confirm("¿Eliminar cotización y ticket vinculado?")) return;

  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"deleteCotizacion",
      folio
    })
  });

  cargar();
}

cargar();
</script>

</body>
</html>
