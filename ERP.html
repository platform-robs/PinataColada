<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Piñata Colada</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
--pink:#ff4fa6;
--yellow:#ffd84d;
--bg:#0f0f13;
--card:#1b1b22;
--muted:#9c9c9c;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:'Montserrat',sans-serif;
}

body{
background:var(--bg);
color:white;
padding:30px 15px;
display:flex;
justify-content:center;
}

.container{
width:100%;
max-width:900px;
}

h1{
text-align:center;
font-weight:800;
margin-bottom:25px;
background:linear-gradient(135deg,var(--pink),var(--yellow));
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

.filtroBox{
text-align:center;
margin-bottom:25px;
}

select{
padding:10px 18px;
border-radius:30px;
border:none;
font-weight:600;
background:var(--card);
color:white;
min-width:220px;
text-align:center;
}

.card{
background:var(--card);
padding:20px;
border-radius:20px;
margin-bottom:20px;
text-align:center;
box-shadow:0 0 20px rgba(0,0,0,0.4);
}

.card h3{
margin-bottom:5px;
font-weight:700;
}

.card p{
color:var(--muted);
margin-bottom:10px;
}

button{
margin-top:8px;
margin-right:6px;
padding:8px 16px;
border-radius:30px;
border:none;
font-weight:600;
cursor:pointer;
background:linear-gradient(135deg,var(--pink),var(--yellow));
color:#000;
}

.delete{
background:#ff3b3b;
color:white;
}

input{
width:100%;
margin-top:10px;
padding:8px;
border-radius:12px;
border:none;
text-align:center;
}

.ticketBox{
margin-top:10px;
background:#111;
padding:10px;
border-radius:12px;
font-size:13px;
}

@media(max-width:600px){
.card{
padding:15px;
}
button{
width:100%;
margin-top:8px;
}
}
</style>
</head>

<body>

<div class="container">

<h1>Panel Cotizaciones</h1>

<div class="filtroBox">
<select id="filtroSelect" onchange="cambiarFiltro(this.value)">
</select>
</div>

<div id="lista"></div>

</div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbzrUJuNsIxO47dL4p3-JZjXL4gR8GneQmRJczlZ1TmaaRTtnDkwsH7Ln7h5dsQQ5fKs/exec";

let cotizaciones=[];
let tickets=[];
let filtroActual="Todos";

async function cargar(){
try{
const res=await fetch(`${API_URL}?action=getAll`);
const data=await res.json();
cotizaciones=data.cotizaciones||[];
tickets=data.tickets||[];
render();
}catch(e){
document.body.innerHTML="<h2 style='color:white;text-align:center'>Error conectando con API</h2>";
}
}

function render(){
renderFiltros();

const lista=document.getElementById("lista");
lista.innerHTML="";

cotizaciones
.filter(c=>filtroActual==="Todos"||c.Estatus===filtroActual)
.forEach(c=>{

const relacionados=tickets.filter(t=>t.Folio===c.Folio);
const puedeCrear=["Pendiente","En Desarrollo","Aprobadas"].includes(c.Estatus);

const card=document.createElement("div");
card.className="card";

card.innerHTML=`
<h3>${c.Folio}</h3>
<p>${c.Cliente}</p>

<select onchange="updateCot(${c.rowIndex},this.value)">
<option ${c.Estatus==="Pendiente"?"selected":""}>Pendiente</option>
<option ${c.Estatus==="En Desarrollo"?"selected":""}>En Desarrollo</option>
<option ${c.Estatus==="Aprobadas"?"selected":""}>Aprobadas</option>
<option ${c.Estatus==="Entregada"?"selected":""}>Entregada</option>
<option ${c.Estatus==="Cancelada"?"selected":""}>Cancelada</option>
</select>

<input type="number" placeholder="Precio"
value="${c.Precio||""}"
onchange="guardarPrecio(${c.rowIndex},this.value)">

${puedeCrear ? `<button onclick="crearTicket('${c.Folio}')">Nuevo Ticket</button>` : ``}

<button onclick="verCotizacion('${c.Folio}')">Ver Cotización</button>
<button onclick="verTickets('${c.Folio}')">Ver Tickets</button>

${relacionados.map((t,i)=>{
const textoAnticipo=
Number(t["Saldo pendiente"])===0
? "Pago"
: "Anticipo";

return `
<div class="ticketBox">
Ticket ${String.fromCharCode(65+i)} —
${textoAnticipo}: ${t.Anticipo} —
Saldo: ${t["Saldo pendiente"]}
</div>
`;
}).join("")}

<button class="delete" onclick="eliminar('${c.Folio}')">Eliminar</button>
`;

lista.appendChild(card);

});
}

function renderFiltros(){
const estados=["Todos","Pendiente","En Desarrollo","Aprobadas","Entregada","Cancelada"];
const contadores={};
estados.forEach(e=>contadores[e]=0);

cotizaciones.forEach(c=>{
contadores["Todos"]++;
if(contadores[c.Estatus]!==undefined)
contadores[c.Estatus]++;
});

const select=document.getElementById("filtroSelect");
select.innerHTML="";

estados.forEach(e=>{
const option=document.createElement("option");
option.value=e;
option.textContent=`${e} (${contadores[e]||0})`;
select.appendChild(option);
});

select.value=filtroActual;
}

function cambiarFiltro(valor){
filtroActual=valor;
render();
}

async function updateCot(rowIndex,estatus){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"updateCotizacion",
rowIndex,
Estatus:estatus
})
});
cargar();
}

async function guardarPrecio(rowIndex,precio){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"updateCotizacion",
rowIndex,
Precio:precio
})
});
}

async function crearTicket(folio){

const c=cotizaciones.find(x=>x.Folio===folio);
const relacionados=tickets.filter(t=>t.Folio===folio);

if(!c.Precio){
alert("Define precio primero");
return;
}

let montoTotal=Number(c.Precio);

if(relacionados.length===0){
let anticipo=Number(prompt("Monto anticipo (0 si es pago completo):"));
if(anticipo===null) return;
await guardarTicketBackend(c,anticipo,montoTotal);
alert("Ticket A generado");
}else{
const ticketA=relacionados[0];
const saldoPendiente=Number(ticketA["Saldo pendiente"]);
if(saldoPendiente<=0){
alert("Ya está liquidado");
return;
}
await guardarTicketBackend(c,saldoPendiente,saldoPendiente);
alert("Ticket B generado");
}

cargar();
}

async function guardarTicketBackend(c,anticipo,precio){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"saveTicket",
...c,
Anticipo:Number(anticipo),
Precio:Number(precio)
})
});
}

function verCotizacion(folio){
const c=cotizaciones.find(x=>x.Folio===folio);
alert(JSON.stringify(c,null,2));
}

function verTickets(folio){
const relacionados=tickets.filter(t=>t.Folio===folio);
if(relacionados.length===0){
alert("Sin tickets");
return;
}
alert(JSON.stringify(relacionados,null,2));
}

async function eliminar(folio){
if(!confirm("Eliminar cotización y todos sus tickets?"))return;
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"deleteCotizacion",
folio
})
});
cargar();
}

cargar();
</script>

</body>
</html>
