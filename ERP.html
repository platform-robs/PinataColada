<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Administrativo | Piñata Colada</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;900&display=swap" rel="stylesheet">

<style>

/* ===============================
   BASE
================================ */

body{
margin:0;
font-family:'Montserrat',sans-serif;
background:#0f1116;
color:white;
}

.container{ padding:25px; }

/* ===============================
   NAVBAR
================================ */

.admin-nav{
display:flex;
justify-content:space-between;
align-items:center;
background:#1b1f2a;
padding:15px 20px;
border-radius:16px;
margin-bottom:20px;
}

.admin-links{
display:flex;
gap:10px;
flex-wrap:wrap;
}

.admin-links button{
background:rgba(255,255,255,.08);
color:white;
border:none;
padding:8px 14px;
border-radius:999px;
cursor:pointer;
font-weight:700;
}

.admin-links button.active{
background:#28a745;
}

.admin-menu-btn{
display:none;
background:rgba(255,255,255,.08);
color:white;
border:none;
padding:8px 12px;
border-radius:10px;
font-size:20px;
}

/* ===============================
   CARDS
================================ */

.card{
background:#1b1f2a;
padding:20px;
border-radius:16px;
margin-bottom:15px;
text-align:center;
}

.card button{
margin:5px;
}

/* ===============================
   BOTONES
================================ */

.btn-primary{ background:#28a745; color:white; }
.btn-edit{ background:#17a2b8; color:white; }
.btn-delete{ background:#dc3545; color:white; }
.btn-ticket{ background:#6f42c1; color:white; }

button{
border:none;
padding:8px 14px;
border-radius:999px;
cursor:pointer;
font-weight:700;
}

/* ===============================
   POPUP
================================ */

.popup-overlay{
position:fixed;
inset:0;
background:rgba(0,0,0,.7);
display:flex;
justify-content:center;
align-items:center;
z-index:999;
}

.popup{
background:white;
color:#222;
width:95%;
max-width:800px;
max-height:90vh;
overflow-y:auto;
border-radius:16px;
padding:25px;
text-align:center;
}

.popup input,
.popup select{
width:100%;
padding:10px;
margin:6px 0;
border-radius:10px;
border:1px solid #ccc;
text-align:center;
}

.close-btn{
background:#dc3545;
color:white;
margin-bottom:10px;
}

/* ===============================
   RESPONSIVE
================================ */

@media(max-width:768px){
.admin-links{ display:none; }
.admin-menu-btn{ display:block; }
}

</style>
</head>

<body>

<div class="container">

<header class="admin-nav">
  <div style="font-weight:900;">Panel — Piñata Colada</div>

  <div class="admin-links" id="navbar"></div>

  <button class="admin-menu-btn" onclick="toggleMenu()">☰</button>
</header>

<div id="lista"></div>

</div>

<script>

const API="https://script.google.com/macros/s/AKfycbzrUJuNsIxO47dL4p3-JZjXL4gR8GneQmRJczlZ1TmaaRTtnDkwsH7Ln7h5dsQQ5fKs/exec";

let cotizaciones=[];
let tickets=[];
let filtroActual="Todos";

/* ===============================
   CARGAR
================================ */

async function cargar(){
const res=await fetch(API+"?action=getAll");
const data=await res.json();

cotizaciones=data.cotizaciones||[];
tickets=data.tickets||[];

render();
renderNavbar();
}

/* ===============================
   NAVBAR CON CONTADORES
================================ */

function renderNavbar(){

const estados=["Pendiente","En Desarrollo","Aprobada","Entregada","Cancelada"];

let html=`<button onclick="setFiltro('Todos')" class="${filtroActual==='Todos'?'active':''}">
Todos (${cotizaciones.length})
</button>`;

estados.forEach(e=>{
const count=cotizaciones.filter(c=>c.Estatus===e).length;

html+=`
<button onclick="setFiltro('${e}')" class="${filtroActual===e?'active':''}">
${e} (${count})
</button>`;
});

document.getElementById("navbar").innerHTML=html;
}

/* ===============================
   FILTRO
================================ */

function setFiltro(f){
filtroActual=f;
render();
renderNavbar();
}

/* ===============================
   RENDER
================================ */

function render(){

const lista=document.getElementById("lista");
lista.innerHTML="";

cotizaciones
.filter(c=>filtroActual==="Todos"||c.Estatus===filtroActual)
.forEach(c=>{

lista.innerHTML+=`
<div class="card">

<h3>${c.Folio} — ${c.Cliente}</h3>
<p><strong>Evento:</strong> ${c.Evento}</p>
<p><strong>Precio:</strong> $${c.Precio||0}</p>
<p><strong>Anticipo:</strong> $${c.Anticipo||0}</p>
<p><strong>Estatus:</strong> ${c.Estatus}</p>

<button class="btn-edit" onclick="editar(${c.rowIndex})">Editar</button>
<button class="btn-ticket" onclick="crearTicket(${c.rowIndex})">Crear Ticket</button>
<button class="btn-delete" onclick="eliminar('${c.Folio}')">Eliminar</button>

</div>
`;
});
}

/* ===============================
   EDITAR COMPLETO
================================ */

function editar(row){

const c=cotizaciones.find(x=>x.rowIndex===row);

let html=`
<h2>Editar Cotización</h2>

<input id="Cliente" value="${c.Cliente||''}">
<input id="Evento" value="${c.Evento||''}">
<input id="Precio" type="number" value="${c.Precio||0}">
<input id="Anticipo" type="number" value="${c.Anticipo||0}">

<select id="Estatus">
<option ${c.Estatus==="Pendiente"?"selected":""}>Pendiente</option>
<option ${c.Estatus==="En Desarrollo"?"selected":""}>En Desarrollo</option>
<option ${c.Estatus==="Aprobada"?"selected":""}>Aprobada</option>
<option ${c.Estatus==="Entregada"?"selected":""}>Entregada</option>
<option ${c.Estatus==="Cancelada"?"selected":""}>Cancelada</option>
</select>

<button class="btn-primary" onclick="guardar(${row})">Guardar</button>
<button class="close-btn" onclick="cerrar()">Cerrar</button>
`;

openPopup(html);
}

/* ===============================
   GUARDAR
================================ */

async function guardar(row){

await fetch(API,{
method:"POST",
body:JSON.stringify({
action:"updateCotizacion",
rowIndex:row,
Cliente:Cliente.value,
Evento:Evento.value,
Precio:Precio.value,
Anticipo:Anticipo.value,
Estatus:Estatus.value
})
});

cerrar();
cargar();
}

/* ===============================
   CREAR TICKET CON CÁLCULO
================================ */

function crearTicket(row){

const c=cotizaciones.find(x=>x.rowIndex===row);

const precio=parseFloat(c.Precio||0);
const anticipo=parseFloat(c.Anticipo||0);
const saldo=precio-anticipo;

let html=`
<h2>Crear Ticket</h2>

<p>Precio: $${precio}</p>
<p>Anticipo: $${anticipo}</p>
<p>Saldo: $${saldo}</p>

<label>Monto del Ticket</label>
<input id="monto" type="number" value="${saldo}">

<select id="tipo">
<option value="Unico">Pago Único</option>
<option value="A">Ticket A</option>
<option value="B">Ticket B</option>
</select>

<button class="btn-primary" onclick="guardarTicket(${row})">Crear</button>
<button class="close-btn" onclick="cerrar()">Cerrar</button>
`;

openPopup(html);
}

async function guardarTicket(row){

const c=cotizaciones.find(x=>x.rowIndex===row);

await fetch(API,{
method:"POST",
body:JSON.stringify({
action:"crearTicket",
rowIndex:row,
Folio:c.Folio,
Tipo:tipo.value,
Monto:monto.value
})
});

cerrar();
cargar();
}

/* ===============================
   ELIMINAR
================================ */

async function eliminar(folio){

if(!confirm("¿Eliminar?")) return;

await fetch(API,{
method:"POST",
body:JSON.stringify({
action:"deleteCotizacion",
folio:folio
})
});

cargar();
}

/* ===============================
   POPUP
================================ */

function openPopup(content){

document.body.insertAdjacentHTML("beforeend",`
<div class="popup-overlay" onclick="cerrar(event)">
<div class="popup" onclick="event.stopPropagation()">
${content}
</div>
</div>
`);
}

function cerrar(){
document.querySelector(".popup-overlay")?.remove();
}

function toggleMenu(){
document.getElementById("navbar").classList.toggle("show");
}

/* ===============================
   INICIAR
================================ */

cargar();

</script>

</body>
</html>
