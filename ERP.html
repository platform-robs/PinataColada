<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800;900&display=swap" rel="stylesheet">

  <style>
    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background:#0f0f0f;
      color:white;
    }

    header{
      padding:18px;
      font-weight:900;
      font-size:18px;
      text-align:center;
      background:linear-gradient(135deg,#ff4fa6,#ffd84f);
      color:black;
    }

    .tabs{
      display:flex;
      position:fixed;
      bottom:0;
      width:100%;
      background:#1c1c1c;
      border-top:1px solid #222;
    }

    .tab{
      flex:1;
      text-align:center;
      padding:14px;
      font-weight:700;
      cursor:pointer;
    }

    .tab.active{
      background:#ffd84f;
      color:black;
    }

    .view{
      display:none;
      padding:15px;
      padding-bottom:80px;
    }

    .view.active{
      display:block;
    }

    .card{
      background:#1f1f1f;
      padding:14px;
      border-radius:14px;
      margin-bottom:12px;
      font-size:14px;
      cursor:pointer;
    }

    .card b{
      font-size:15px;
    }

    input{
      width:100%;
      padding:12px;
      margin-bottom:12px;
      border-radius:10px;
      border:none;
      font-size:14px;
    }

    .btn{
      width:100%;
      padding:14px;
      border-radius:12px;
      border:none;
      font-weight:900;
      font-size:14px;
      margin-bottom:12px;
      cursor:pointer;
    }

    .btn-primary{
      background:#ffd84f;
      color:black;
    }

    .btn-secondary{
      background:#333;
      color:white;
    }

    .ticket-preview{
      background:white;
      color:black;
      padding:20px;
      border-radius:12px;
      font-size:13px;
      margin-top:10px;
      box-shadow:0 0 20px rgba(0,0,0,.5);
    }

    .ticket-title{
      text-align:center;
      font-weight:900;
      margin-bottom:10px;
      font-size:16px;
    }

  </style>
</head>
<body>

<header>PIÑATA COLADA — ADMIN</header>

<!-- =========================
     VISTA COTIZACIONES
========================= -->

<div class="view active" id="cotizacionesView">
  <h3>Cotizaciones</h3>
  <div id="cotizaciones"></div>
</div>

<!-- =========================
     VISTA TICKETS
========================= -->

<div class="view" id="ticketsView">
  <h3>Tickets</h3>
  <div id="tickets"></div>
</div>

<!-- =========================
     VISTA EDITOR
========================= -->

<div class="view" id="editorView">
  <h3>Editor Ticket</h3>

  <button class="btn btn-secondary" onclick="nuevoTicket()">Nuevo Ticket</button>

  <input id="folio" placeholder="Folio">
  <input id="cliente" placeholder="Cliente">
  <input id="tamano" placeholder="Tamaño">
  <input id="diseno" placeholder="Diseño">
  <input id="fechaEntrega" placeholder="Fecha de entrega">
  <input id="telefono" placeholder="Teléfono">
  <input id="precio" placeholder="Precio cotizado">
  <input id="anticipo" placeholder="Anticipo">
  <input id="saldo" placeholder="Saldo pendiente">

  <button class="btn btn-primary" onclick="guardar()">Guardar Ticket</button>

  <div class="ticket-preview" id="preview"></div>

</div>

<!-- =========================
     TABS
========================= -->

<div class="tabs">
  <div class="tab active" onclick="cambiarVista('cotizacionesView',this)">Cotizaciones</div>
  <div class="tab" onclick="cambiarVista('ticketsView',this)">Tickets</div>
  <div class="tab" onclick="cambiarVista('editorView',this)">Editor</div>
</div>

<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>

let cotizaciones = [];
let tickets = [];

/* =========================
   CAMBIO DE VISTA
========================= */

function cambiarVista(id,el){
  document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  el.classList.add("active");
}

/* =========================
   CARGAR DATA
========================= */

google.script.run.withSuccessHandler(data=>{
  cotizaciones = data;
  renderCotizaciones();
}).obtenerCotizaciones();

google.script.run.withSuccessHandler(data=>{
  tickets = data;
  renderTickets();
}).obtenerTickets();

/* =========================
   RENDER
========================= */

function renderCotizaciones(){
  const container = document.getElementById("cotizaciones");
  container.innerHTML="";
  cotizaciones.forEach(c=>{
    container.innerHTML+=`
      <div class="card" onclick='cargarDesdeCotizacion(${JSON.stringify(c)}); cambiarVista("editorView", document.querySelectorAll(".tab")[2]);'>
        <b>${c.Folio}</b><br>
        ${c.Cliente}<br>
        ${c.Estatus || ""}
      </div>
    `;
  });
}

function renderTickets(){
  const container=document.getElementById("tickets");
  container.innerHTML="";
  tickets.forEach(t=>{
    container.innerHTML+=`
      <div class="card" onclick='cargarTicket(${JSON.stringify(t)}); cambiarVista("editorView", document.querySelectorAll(".tab")[2]);'>
        <b>${t.Folio}</b><br>
        ${t.Cliente}
      </div>
    `;
  });
}

/* =========================
   ACCIONES
========================= */

function cargarDesdeCotizacion(c){
  folio.value=c.Folio;
  cliente.value=c.Cliente;
  tamano.value=c.Tamaño;
  diseno.value=c.Diseño;
  fechaEntrega.value=c["Fecha de entrega"];
  telefono.value=c.Teléfono;
  actualizarPreview();
}

function cargarTicket(t){
  folio.value=t.Folio;
  cliente.value=t.Cliente;
  tamano.value=t.Tamaño;
  diseno.value=t.Diseño;
  fechaEntrega.value=t["Fecha de entrega"];
  telefono.value=t.Teléfono;
  precio.value=t["Precio cotizado"];
  anticipo.value=t.Anticipo;
  saldo.value=t["Saldo pendiente"];
  actualizarPreview();
}

function nuevoTicket(){
  document.querySelectorAll("input").forEach(i=>i.value="");
  actualizarPreview();
}

document.querySelectorAll("input").forEach(i=>{
  i.addEventListener("input",actualizarPreview);
});

function actualizarPreview(){
  preview.innerHTML=`
    <div class="ticket-title">PIÑATA COLADA</div>
    Folio: ${folio.value}<br>
    Cliente: ${cliente.value}<br>
    Tamaño: ${tamano.value}<br>
    Diseño: ${diseno.value}<br>
    Entrega: ${fechaEntrega.value}<br>
    Tel: ${telefono.value}<br>
    Precio: $${precio.value}<br>
    Anticipo: $${anticipo.value}<br>
    Saldo: $${saldo.value}
  `;
}

function guardar(){

  const ticket={
    folio:folio.value,
    fechaSolicitud:new Date(),
    cliente:cliente.value,
    tamano:tamano.value,
    diseno:diseno.value,
    fechaEntrega:fechaEntrega.value,
    evento:"",
    telefono:telefono.value,
    precio:precio.value,
    anticipo:anticipo.value,
    saldo:saldo.value,
    metodoPago:"",
    entrega:""
  };

  google.script.run.guardarTicket(ticket);

  html2canvas(document.getElementById("preview")).then(canvas=>{
    const base64=canvas.toDataURL("image/png");
    google.script.run.guardarTicketImagen(base64,ticket.folio);
  });

  alert("Ticket guardado correctamente");
}

</script>

</body>
</html>
