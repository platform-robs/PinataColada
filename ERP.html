<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Panel Piñata Colada</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
--pink:#ff4fa6;
--yellow:#ffd84d;
--bg:#0f0f13;
--card:#1b1b22;
--muted:#9c9c9c;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:'Montserrat',sans-serif;
}

body{
background:var(--bg);
color:white;
padding:20px;
}

h1{
text-align:center;
font-weight:800;
margin-bottom:20px;
background:linear-gradient(135deg,var(--pink),var(--yellow));
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

.topbar{
display:flex;
overflow:auto;
gap:8px;
margin-bottom:20px;
}

.badge{
background:var(--card);
padding:10px 14px;
border-radius:30px;
font-size:12px;
white-space:nowrap;
cursor:pointer;
}

.card{
background:var(--card);
padding:18px;
border-radius:20px;
margin-bottom:16px;
}

button{
margin-top:8px;
margin-right:6px;
padding:8px 14px;
border-radius:30px;
border:none;
font-weight:600;
cursor:pointer;
background:linear-gradient(135deg,var(--pink),var(--yellow));
color:#000;
}

.delete{
background:#ff3b3b;
color:white;
}

input,select{
width:100%;
margin-top:6px;
padding:8px;
border-radius:12px;
border:none;
}
.ticketBox{
margin-top:8px;
background:#111;
padding:8px;
border-radius:10px;
font-size:12px;
}
</style>
</head>

<body>

<h1>Panel Cotizaciones</h1>

<div class="topbar" id="filtros"></div>
<div id="lista"></div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbwD2O35MG9wT3TBjgY-w596QeKRjHiPPsl2enELb5nN3aIXtvXLOuga-hVJ_c3R9wVZ/exec";

let cotizaciones=[];
let tickets=[];
let filtroActual="Todos";

async function cargar(){
const res=await fetch(`${API_URL}?action=getAll`);
const data=await res.json();
cotizaciones=data.cotizaciones;
tickets=data.tickets;
render();
}

function render(){

renderFiltros();

const lista=document.getElementById("lista");
lista.innerHTML="";

cotizaciones
.filter(c=>filtroActual==="Todos"||c.Estatus===filtroActual)
.forEach(c=>{

const relacionados=tickets.filter(t=>t.Folio===c.Folio);
const puedeCrear=["Pendiente","En Desarrollo","Aprobadas"].includes(c.Estatus);

const card=document.createElement("div");
card.className="card";

card.innerHTML=`
<h3>${c.Folio}</h3>
<p>${c.Cliente}</p>

<select onchange="updateCot(${c.rowIndex},this.value)">
<option ${c.Estatus==="Pendiente"?"selected":""}>Pendiente</option>
<option ${c.Estatus==="En Desarrollo"?"selected":""}>En Desarrollo</option>
<option ${c.Estatus==="Aprobadas"?"selected":""}>Aprobadas</option>
<option ${c.Estatus==="Entregada"?"selected":""}>Entregada</option>
<option ${c.Estatus==="Cancelada"?"selected":""}>Cancelada</option>
</select>

<input type="number" placeholder="Precio"
value="${c.Precio||""}"
onchange="guardarPrecio(${c.rowIndex},this.value)">

${puedeCrear ? `<button onclick="crearTicket('${c.Folio}')">Nuevo Ticket</button>` : ``}

<button onclick="verCotizacion('${c.Folio}')">Ver Cotización</button>
<button onclick="verTickets('${c.Folio}')">Ver Tickets</button>

${relacionados.map((t,i)=>{

const textoAnticipo=
Number(t["Saldo pendiente"])===0
? "Pago"
: "Anticipo";

return `
<div class="ticketBox">
Ticket ${String.fromCharCode(65+i)} —
${textoAnticipo}: ${t.Anticipo} —
Saldo: ${t["Saldo pendiente"]}
</div>
`;

}).join("")}

<button class="delete" onclick="eliminar('${c.Folio}')">Eliminar</button>
`;

lista.appendChild(card);

});

}

function renderFiltros(){

const estados=["Todos","Pendiente","En Desarrollo","Aprobadas","Entregada","Cancelada"];
const contadores={};
estados.forEach(e=>contadores[e]=0);

cotizaciones.forEach(c=>{
contadores["Todos"]++;
if(contadores[c.Estatus]!==undefined)
contadores[c.Estatus]++;
});

const div=document.getElementById("filtros");
div.innerHTML="";

estados.forEach(e=>{
const el=document.createElement("div");
el.className="badge";
el.innerText=`${e} (${contadores[e]||0})`;
el.onclick=()=>{filtroActual=e;render();}
div.appendChild(el);
});
}

async function updateCot(rowIndex,estatus){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"updateCotizacion",
rowIndex,
Estatus:estatus
})
});
cargar();
}

async function guardarPrecio(rowIndex,precio){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"updateCotizacion",
rowIndex,
Precio:precio
})
});
}

async function crearTicket(folio){

const c=cotizaciones.find(x=>x.Folio===folio);
const relacionados=tickets.filter(t=>t.Folio===folio);

if(!c.Precio){
alert("Define precio primero");
return;
}

let montoTotal=Number(c.Precio);

// Ticket A
if(relacionados.length===0){

const tipo=prompt("1 = Anticipo\n2 = Pago completo");
if(!tipo) return;

let anticipo=0;

if(tipo==="1"){
anticipo=Number(prompt("Monto del anticipo:"));
if(!anticipo) return;
}

if(tipo==="2"){
anticipo=montoTotal;
}

await guardarTicketBackend(c,anticipo,montoTotal);
alert("Ticket A generado");
}

// Ticket B
else{

const ticketA=relacionados[0];
const saldoPendiente=Number(ticketA["Saldo pendiente"]);

if(saldoPendiente<=0){
alert("Ya está liquidado");
return;
}

await guardarTicketBackend(c,saldoPendiente,saldoPendiente);
alert("Ticket B generado");
}

cargar();
}

async function guardarTicketBackend(c,anticipo,precio){
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"saveTicket",
...c,
Anticipo:Number(anticipo),
Precio:Number(precio)
})
});
}

function verCotizacion(folio){
const c=cotizaciones.find(x=>x.Folio===folio);
alert(`
Folio: ${c.Folio}
Cliente: ${c.Cliente}
Tamaño: ${c.Tamaño}
Diseño: ${c.Diseño}
Evento: ${c.Evento}
Entrega: ${c["Fecha de entrega"]}
Teléfono: ${c["Teléfono"]}
Precio: ${c.Precio}
Estatus: ${c.Estatus}
`);
}

function verTickets(folio){
const relacionados=tickets.filter(t=>t.Folio===folio);
if(relacionados.length===0){
alert("Sin tickets");
return;
}
let texto="";
relacionados.forEach((t,i)=>{
texto+=`
Ticket ${String.fromCharCode(65+i)}
Anticipo: ${t.Anticipo}
Saldo: ${t["Saldo pendiente"]}

`;
});
alert(texto);
}

async function eliminar(folio){
if(!confirm("Eliminar cotización y todos sus tickets?"))return;
await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"deleteCotizacion",
folio
})
});
cargar();
}

cargar();
</script>

</body>
</html>
