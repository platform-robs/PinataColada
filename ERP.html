<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Panel Piñata Colada</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">

<style>
:root{
--pink:#ff4fa6;
--yellow:#ffd84d;
--bg:#0f0f13;
--card:#1b1b22;
--muted:#9c9c9c;
}

*{
margin:0;
padding:0;
box-sizing:border-box;
font-family:'Montserrat',sans-serif;
}

body{
background:var(--bg);
color:white;
padding:30px 15px;
display:flex;
justify-content:center;
}

.container{
width:100%;
max-width:950px;
}

h1{
text-align:center;
font-weight:800;
margin-bottom:25px;
background:linear-gradient(135deg,var(--pink),var(--yellow));
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

/* FILTRO */
.filtro{
margin-bottom:25px;
text-align:center;
}

select{
padding:10px 18px;
border-radius:30px;
border:none;
background:var(--card);
color:white;
font-weight:600;
}

/* CARD */
.card{
background:var(--card);
padding:20px;
border-radius:20px;
margin-bottom:20px;
box-shadow:0 0 20px rgba(0,0,0,0.4);
}

.card h3{
margin-bottom:5px;
}

.card small{
color:var(--muted);
}

button{
margin-top:10px;
margin-right:6px;
padding:8px 16px;
border-radius:30px;
border:none;
font-weight:600;
cursor:pointer;
background:linear-gradient(135deg,var(--pink),var(--yellow));
color:#000;
}

.delete{
background:#ff3b3b;
color:white;
}

input{
width:100%;
margin-top:10px;
padding:8px;
border-radius:12px;
border:none;
}

/* POPUP */
.popup{
position:fixed;
inset:0;
background:rgba(0,0,0,.85);
display:none;
align-items:center;
justify-content:center;
z-index:9999;
}

.popup.active{
display:flex;
}

.popup-card{
background:#1a1a2e;
width:95%;
max-width:650px;
padding:30px;
border-radius:25px;
max-height:90vh;
overflow:auto;
}

.popup-card h2{
margin-bottom:20px;
background:linear-gradient(135deg,var(--pink),var(--yellow));
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;
}

.popup-section{
margin-bottom:18px;
padding-bottom:10px;
border-bottom:1px solid rgba(255,255,255,.1);
}

.popup-section p{
margin:6px 0;
}

.close-btn{
background:none;
border:none;
color:white;
font-size:24px;
float:right;
cursor:pointer;
}
</style>
</head>

<body>

<div class="container">
<h1>Panel Cotizaciones</h1>

<div class="filtro">
<select id="filtro" onchange="render()">
<option value="Todos">Todos</option>
<option value="Pendiente">Pendiente</option>
<option value="En Desarrollo">En Desarrollo</option>
<option value="Aprobada">Aprobada</option>
<option value="Entregada">Entregada</option>
<option value="Cancelada">Cancelada</option>
</select>
</div>

<div id="lista"></div>
</div>

<div class="popup" id="popup">
<div class="popup-card">
<button class="close-btn" onclick="closePopup()">×</button>
<h2 id="popupTitle"></h2>
<div id="popupContent"></div>
</div>
</div>

<script>

const API_URL="https://script.google.com/macros/s/AKfycbzrUJuNsIxO47dL4p3-JZjXL4gR8GneQmRJczlZ1TmaaRTtnDkwsH7Ln7h5dsQQ5fKs/exec";

let cotizaciones=[];
let tickets=[];

async function cargar(){
try{
const res=await fetch(`${API_URL}?action=getAll`);
const data=await res.json();
cotizaciones=data.cotizaciones||[];
tickets=data.tickets||[];
render();
}catch(e){
alert("Error conectando con API");
}
}

function render(){

const filtro=document.getElementById("filtro").value;
const lista=document.getElementById("lista");
lista.innerHTML="";

cotizaciones
.filter(c=>filtro==="Todos" || c.Estatus===filtro)
.forEach(c=>{

const relacionados=tickets.filter(t=>t.Folio===c.Folio);
const saldoTotal=relacionados.length>0 ? Number(relacionados[relacionados.length-1]["Saldo pendiente"]) : Number(c.Precio||0);

const card=document.createElement("div");
card.className="card";

card.innerHTML=`
<h3>${c.Folio}</h3>
<small>${c.Cliente}</small>

<p><strong>Precio:</strong> $${c.Precio||0}</p>
<p><strong>Saldo actual:</strong> $${saldoTotal}</p>

<select onchange="updateEstatus(${c.rowIndex},this.value)">
<option ${c.Estatus==="Pendiente"?"selected":""}>Pendiente</option>
<option ${c.Estatus==="En Desarrollo"?"selected":""}>En Desarrollo</option>
<option ${c.Estatus==="Aprobada"?"selected":""}>Aprobada</option>
<option ${c.Estatus==="Entregada"?"selected":""}>Entregada</option>
<option ${c.Estatus==="Cancelada"?"selected":""}>Cancelada</option>
</select>

<input type="number" value="${c.Precio||""}" placeholder="Actualizar precio"
onchange="guardarPrecio(${c.rowIndex},this.value)">

<br>
<button onclick="crearTicket('${c.Folio}')">Nuevo Ticket</button>
<button onclick="verCotizacion('${c.Folio}')">Ver</button>
<button onclick="editarCotizacion('${c.Folio}')">Editar</button>
<button onclick="verTickets('${c.Folio}')">Tickets</button>
<button class="delete" onclick="eliminar('${c.Folio}')">Eliminar</button>
`;

lista.appendChild(card);

});
}

/* CREAR TICKET */
async function crearTicket(folio){

const c=cotizaciones.find(x=>x.Folio===folio);
if(!c || Number(c.Precio)<=0){
alert("Define precio válido primero");
return;
}

const relacionados=tickets.filter(t=>t.Folio===folio);
let saldoActual=Number(c.Precio);

if(relacionados.length>0){
saldoActual=Number(relacionados[relacionados.length-1]["Saldo pendiente"]);
}

if(saldoActual<=0){
alert("Ya está liquidado. No se pueden generar más tickets.");
return;
}

let anticipo=Number(prompt(`Saldo disponible: $${saldoActual}\nIngresa monto a pagar:`));
if(isNaN(anticipo) || anticipo<=0) return;

if(anticipo>saldoActual){
alert("No puede exceder el saldo.");
return;
}

await fetch(API_URL,{
method:"POST",
body:JSON.stringify({
action:"saveTicket",
...c,
Anticipo:anticipo,
Precio:saldoActual
})
});

cargar();
}

/* POPUPS ORDENADOS */

function verCotizacion(folio){
const c=cotizaciones.find(x=>x.Folio===folio);

openPopup("Cotización "+folio,`
<div class="popup-section">
<p><strong>Cliente:</strong> ${c.Cliente}</p>
<p><strong>Tamaño:</strong> ${c.Tamaño}</p>
<p><strong>Diseño:</strong> ${c.Diseño}</p>
<p><strong>Evento:</strong> ${c.Evento}</p>
<p><strong>Entrega:</strong> ${c.Entrega}</p>
</div>

<div class="popup-section">
<p><strong>Precio:</strong> $${c.Precio}</p>
<p><strong>Estatus:</strong> ${c.Estatus}</p>
</div>
`);
}

function verTickets(folio){
const relacionados=tickets.filter(t=>t.Folio===folio);

if(relacionados.length===0){
openPopup("Tickets","Sin tickets");
return;
}

openPopup("Tickets "+folio,
relacionados.map((t,i)=>`
<div class="popup-section">
<h3>Ticket ${String.fromCharCode(65+i)}</h3>
<p><strong>Anticipo:</strong> $${t.Anticipo}</p>
<p><strong>Saldo pendiente:</strong> $${t["Saldo pendiente"]}</p>
<button onclick="editarTicket(${t.rowIndex})">Editar Ticket</button>
</div>
`).join("")
);
}

/* EDICIONES */

function editarCotizacion(folio){
const c=cotizaciones.find(x=>x.Folio===folio);

openPopup("Editar Cotización",
`<form onsubmit="guardarEdicionCot(event,${c.rowIndex})">
<input name="Cliente" value="${c.Cliente}">
<input name="Tamaño" value="${c.Tamaño}">
<input name="Diseño" value="${c.Diseño}">
<input name="Evento" value="${c.Evento}">
<input name="Entrega" value="${c.Entrega}">
<input name="Precio" type="number" value="${c.Precio}">
<br><button type="submit">Guardar</button>
</form>`);
}

async function guardarEdicionCot(e,rowIndex){
e.preventDefault();
const datos=Object.fromEntries(new FormData(e.target).entries());
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"updateCotizacion",rowIndex,...datos})});
closePopup();
cargar();
}

function editarTicket(rowIndex){
const t=tickets.find(x=>x.rowIndex===rowIndex);

openPopup("Editar Ticket",
`<form onsubmit="guardarEdicionTicket(event,${rowIndex})">
<input name="Anticipo" type="number" value="${t.Anticipo}">
<input name="Precio" type="number" value="${t.Precio}">
<input name="Saldo pendiente" type="number" value="${t["Saldo pendiente"]}">
<br><button type="submit">Guardar</button>
</form>`);
}

async function guardarEdicionTicket(e,rowIndex){
e.preventDefault();
const datos=Object.fromEntries(new FormData(e.target).entries());
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"updateCotizacion",rowIndex,...datos})});
closePopup();
cargar();
}

async function updateEstatus(rowIndex,estatus){
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"updateCotizacion",rowIndex,Estatus:estatus})});
cargar();
}

async function guardarPrecio(rowIndex,precio){
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"updateCotizacion",rowIndex,Precio:precio})});
cargar();
}

async function eliminar(folio){
if(!confirm("Eliminar cotización y tickets?"))return;
await fetch(API_URL,{method:"POST",body:JSON.stringify({action:"deleteCotizacion",folio})});
cargar();
}

function openPopup(title,content){
document.getElementById("popupTitle").innerText=title;
document.getElementById("popupContent").innerHTML=content;
document.getElementById("popup").classList.add("active");
}

function closePopup(){
document.getElementById("popup").classList.remove("active");
}

cargar();
</script>

</body>
</html>
